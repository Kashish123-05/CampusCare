<div id="chatbot-widget" style="position:fixed;bottom:20px;right:20px;z-index:9999;">
    <div id="chatbot-panel" class="card shadow" style="display:none;width:350px;height:450px;position:absolute;bottom:60px;right:0;">
        <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
            <span><i class="bi bi-robot"></i> Campus Assistant</span>
            <button type="button" class="btn btn-sm btn-light" id="chatbot-close">&times;</button>
        </div>
        <div class="card-body p-0 d-flex flex-column" style="height:360px;">
            <div id="chatbot-messages" style="flex:1;overflow-y:auto;padding:1rem;font-size:0.9rem;"></div>
            <div class="p-2 border-top">
                <form id="chatbot-form" class="d-flex gap-1">
                    {% csrf_token %}
                    <input type="text" id="chatbot-input" class="form-control form-control-sm" placeholder="Ask something..." autocomplete="off">
                    <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-send"></i></button>
                </form>
            </div>
        </div>
    </div>
    <button id="chatbot-toggle" class="btn btn-primary btn-lg rounded-circle shadow" title="Campus Assistant">
        <i class="bi bi-chat-dots-fill"></i>
    </button>
</div>

<script>
(function() {
    const panel = document.getElementById('chatbot-panel');
    const toggle = document.getElementById('chatbot-toggle');
    const closeBtn = document.getElementById('chatbot-close');
    const messagesDiv = document.getElementById('chatbot-messages');
    const form = document.getElementById('chatbot-form');
    const input = document.getElementById('chatbot-input');
    const csrf = document.querySelector('#chatbot-form input[name=csrfmiddlewaretoken]');

    function appendMsg(text, isUser) {
        const div = document.createElement('div');
        div.className = 'mb-2';
        div.innerHTML = '<span class="badge ' + (isUser ? 'bg-primary' : 'bg-secondary') + '">' + (isUser ? 'You' : 'Assistant') + '</span><br><div class="mt-1">' + text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') + '</div>';
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function openChatbot() {
        panel.style.display = 'block';
        input.focus();
    }
    window.openCampusAssistant = openChatbot;

    toggle.addEventListener('click', function() {
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        if (panel.style.display === 'block') input.focus();
    });
    if (closeBtn) closeBtn.addEventListener('click', function() { panel.style.display = 'none'; });

    document.getElementById('nav-ai-assistant')?.addEventListener('click', function(e) {
        e.preventDefault();
        openChatbot();
    });

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const msg = input.value.trim();
        if (!msg) return;
        appendMsg(msg, true);
        input.value = '';
        input.disabled = true;

        const fd = new FormData();
        fd.append('message', msg);
        fd.append('csrfmiddlewaretoken', csrf ? csrf.value : '');

        fetch('{% url "chatbot:chat_send" %}', {
            method: 'POST',
            body: fd,
            headers: { 'X-CSRFToken': csrf ? csrf.value : '', 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(r => r.json())
        .then(data => {
            appendMsg(data.response || 'Sorry, something went wrong.', false);
        })
        .catch(() => appendMsg('Connection error. Please try again.', false))
        .finally(() => { input.disabled = false; input.focus(); });
    });
})();
</script>
